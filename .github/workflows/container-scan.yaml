name: "Container-scan - Trivy"
on: [push]
jobs:
  build:
    name: Build
    runs-on: ubuntu-18.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      
      - name: Build an image from Dockerfile
        run: |
          docker build -t hello-world:${{ github.sha }} .
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'hello-world:${{ github.sha }}'
          format: 'json'
          output: 'report.json'
          
      - name: Upload the result
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'
      - name: Upload Scan result
        run: |
            curl -sL -O https://raw.githubusercontent.com/muralidkt/defectdojo-client/main/test/defectdojo_apiv2.py
            curl -sL -O https://raw.githubusercontent.com/muralidkt/defectdojo-client/main/test/defectdojo.py
            pip install requests
            python3 defectdojo.py --host https://defectdojo.shellctl.com --api_token ${secret.dd_api_token} --engagement ${secret.dd_engagement} --user ${secret.dd_user} --product_name ${secret.dd_product_name} --file report.json --scanner "Trivy Scan"
   
      