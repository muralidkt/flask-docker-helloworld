name: "Container-scan - Trivy"

on: [push]
jobs:
  build:
    name: Build
    runs-on: ubuntu-18.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      
      - name: Build an image from Dockerfile
        run: |
          docker build -t hello-world:${{ github.sha }} .
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'hello-world:${{ github.sha }}'
          format: 'json'
          output: 'report.json'
      - name: Downaload the scripts
        run: |
          curl -sL -O https://raw.githubusercontent.com/muralidkt/defectdojo-client/main/test/defectdojo_apiv2.py
          curl -sL -O https://raw.githubusercontent.com/muralidkt/defectdojo-client/main/test/defectdojo.py
        
      - name: Upload the result
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'
      - run: python3 defectdojo.py --host https://defectdojo.shellctl.com --api_token 1ade1e0980c87b2cf8aa44e8ab5031c6622123c7 --engagement_name app1 --user admin --product_name producti-1 --file report.json --scanner "Trivy Scan"
   
      